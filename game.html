<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>Chowka Bhara</title>
		<link type="text/css" rel="stylesheet" href="main.css" media="screen">
		<script type="text/javascript" src="jquery.min.js"></script>
		<script type="text/javascript" src="jquery.url.js"></script>
		<script src="nowjs/now.js"></script> 
		<script src="raphael.js" type="text/javascript" charset="utf-8"></script>
		<script src="cb.js" type="text/javascript" charset="utf-8"></script>
		<script src="jquery_popup.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			var moderator = 0, client = 0;
			var is_moderator = false;

			function refresh_users_list(){
				// get all group users and populate the list
	      now.getGroupUsers(function(users){
	      	var users_list = "Remove player(s) from Game room : ";
	      	$.each(users, function(key, user){
	      		if(is_moderator && user != moderator){
	      			now.getUserNameById(user, function(name){
								users_list += "<a class='menu_item' href='#' user_id='" +
								 user + "' id='" + user + "'>Player " +
		      			 name + "</a>&nbsp;&nbsp;&nbsp;";	      				
		      			$("#users_list").html(users_list);
							});	      			
	      		}
	      	});
	      });
			}

			$("#users_list a").live('click', function(){
				var user_id = $(this).attr('user_id');
				var link_id = '#' + $(this).attr('id');
				now.getUserNameById(user_id, function(name){
					now.distributeMessage(name + " was removed from this room by Moderator");
					now.removeUserByModerator(user_id, function(user_id){
						$(link_id).hide(400);
					});
				});				
			});

			$("#leave_room").live('click', function(){
				now.distributeMessage(" left the room");
				now.leaveRoom(function(){
					window.location = "/";
				});
			});

			$("#lock_room").live('click', function(){
				var link_id = '#' + $(this).attr('id');
				now.lockRoom(function(is_locked){
					if(is_locked){
						$(link_id).hide(400);
						now.distributeMessage(" locked the room");
					}else{
						$('#menu_messages').html("Not enough players to Lock the room<br/>");
						setTimeout(function(){
							$('#menu_messages').html("");
						},5000);
					}
				});
			});

			$("#help_div").live('click', function(){
				$.get('README', function(data) {
        	$("#contactArea").html($(data));
        	loadPopup();
					centerPopup();
      	});
			});

			$("#help_close_link").live('click', function(){
				disablePopup();
			});
			
			$(document).ready(function(){
				now.ready(function(){
					var room = $.url().param('room');
					now.name = prompt("And you are...?", "Guest" + new Date().getTime());
					// place the current user in the game room
					now.changeRoom(room, function(success){
						if(!success)
							window.location = "/"; // room locked, redirect back
						else{
							// appoint a moderator for the current game room
							now.groupModerator(function(moderator_id){
								moderator = moderator_id;
				      	now.userClientId(function(client_id){
				      		client = client_id;
				      		var load_msg = " joins the game";
				      		if(client == moderator){
				      			load_msg += " as moderator";
				      			is_moderator = true;
				      			$("#moderator_menu").show(400);
				      			$("#role_dice").removeAttr("disabled");
				      			$('#score').html("Please ROLL DICE ...");
				      			now.distributeGamePlay("Moderator starts the game by rolling the dice first, please wait till room is locked");
				      		}
				      		now.distributeMessage(load_msg);
				      	});
				      });

				      refresh_users_list();
				      loadCB();      	
			    	}
					});
				});
				
				// Receive messages from people in the same group
				now.receiveMessage = function(name, message){
					var new_message = "<br/><b>" + name + "</b>: " + message;
					var old_message = $("#messages").html();
					if(old_message != null)
						new_message += old_message;					
					$("#messages").html(new_message);
					if(new_message.indexOf("joins the game") != -1 || new_message.indexOf("left the room") != -1)
						refresh_users_list();				
					var removed_user = message.substring(0, message.indexOf(" was removed"));
					if(removed_user == now.name){
						alert("Oops... moderator has removed you from the game room");
						window.location = "/";
					}						
				};

				// Receive messages from people in the same group
				now.receiveGamePlay = function(message){
					var new_message = "<span class='current_info'>" + message + "</span><br/>";
					var old_message = $("#game_play_info").html();					
					if(old_message != null){
						old_message = old_message.replace("current_info", "old_info");
						new_message += old_message;
					}						
					$("#game_play_info").html(new_message);
					
					// check dice enable
					var expr = now.name + "'s turn to play";
					if(message.indexOf("turn to play") != -1){
						$('#dice_stack').html("");
						if(message.indexOf(expr) != -1){
							$('#role_dice').removeAttr("disabled");
							$('#score').html("Please ROLL DICE ...");
						}else{
							$('#role_dice').attr("disabled", "disabled");						
							$('#score').html("Wait for your turn ...");
						}
					}
				};

				// Send messages to people in the same group
				$("#send-button").click(function(){
					now.distributeMessage($("#text-input").val());
					$("#text-input").val("");
				});				
			});
		</script>
	</head>
	<body>
		<div id="popupContact">		
			<div id="contactArea">
				<center><img src='ajax-loading.gif'/></center>
				<center><b>Loading Please wait ...</b></center> 
			</div>
		</div>
		<div id="backgroundPopup"></div>

		<h2><center>Chowka Bhara - A Classical Indian Multiplayer Board Game</center></h2>
		<p id='game_play_info' class="game_play"></p>
		<div id="holder" class="holder"></div>
		<div class="game_panel">
			<div id='uuidDiv'></div>
			<button id='role_dice' disabled="disabled" onClick="javascript:play_game()">ROLL DICE</button>
			<span id="score" class="score"></span>
			<p class='stack' id="dice_stack"></p>
			<hr/>
			<div class="messages">
				<input type="text" id="text-input" maxlength="40"/>
				<input type="submit" value="Send message" id="send-button"/>
				<p id="messages"></p>
			</div>
			<hr/>
			<div id="menu" class='menu'>
				<p id='menu_messages'></p>
				<a class='menu_item' id='help_div' href='#'>Help</a>
				<a class='menu_item' id='leave_room' href='#'>Leave Room</a>
				<span id="moderator_menu" class="moderator_menu">
					<a class='menu_item' id='lock_room' href='#'>Lock Room</a>
					<br/>				
					<p id='users_list'></p>					
				</span>
			</div>
		</div>
	</body>
</html>